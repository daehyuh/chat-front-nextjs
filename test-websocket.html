<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Not connected</div>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <button onclick="subscribe()">Subscribe to Room 1</button>
    <button onclick="sendMessage()">Send Test Message</button>
    <div id="messages"></div>

    <script>
        let stompClient = null;
        const token = localStorage.getItem('token');
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            console.log(message);
        }
        
        function addMessage(message) {
            const div = document.getElementById('messages');
            div.innerHTML += '<p>' + message + '</p>';
        }

        function connect() {
            if (!token) {
                updateStatus('No token found. Please login first.');
                return;
            }
            
            updateStatus('Connecting...');
            
            const client = new StompJs.Client({
                webSocketFactory: () => {
                    return new SockJS('https://api.bob-dev.click/connect');
                },
                connectHeaders: {
                    Authorization: `Bearer ${token}`
                },
                debug: function (str) {
                    console.log('STOMP: ' + str);
                    addMessage('DEBUG: ' + str);
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 10000,
                heartbeatOutgoing: 10000,
                onConnect: function(frame) {
                    updateStatus('Connected!');
                    console.log('Connected: ' + frame);
                    addMessage('Connected to STOMP server');
                },
                onStompError: function(frame) {
                    updateStatus('STOMP Error!');
                    console.error('STOMP error: ', frame.headers['message']);
                    console.error('Error body: ', frame.body);
                    addMessage('ERROR: ' + frame.headers['message']);
                },
                onWebSocketError: function(error) {
                    updateStatus('WebSocket Error!');
                    console.error('WebSocket error: ', error);
                    addMessage('WebSocket ERROR: ' + error);
                },
                onDisconnect: function() {
                    updateStatus('Disconnected');
                    addMessage('Disconnected from STOMP server');
                }
            });
            
            client.activate();
            stompClient = client;
        }

        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
                stompClient = null;
            }
        }

        function subscribe() {
            if (!stompClient || !stompClient.connected) {
                alert('Not connected!');
                return;
            }
            
            stompClient.subscribe('/topic/chat/1', function(message) {
                console.log('Received:', message.body);
                addMessage('Received: ' + message.body);
            });
            
            addMessage('Subscribed to room 1');
        }

        function sendMessage() {
            if (!stompClient || !stompClient.connected) {
                alert('Not connected!');
                return;
            }
            
            const message = {
                messageType: 'CHAT',
                roomId: 1,
                content: 'Test message from debug page',
                token: token
            };
            
            stompClient.publish({
                destination: '/app/chat/1',
                body: JSON.stringify(message)
            });
            
            addMessage('Sent test message');
        }
    </script>
</body>
</html>